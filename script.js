//random text for test type
let text_repo = [
    //1
    "The sky above the port was the color of television, tuned to a dead channel. It was a dark and stormy night; the rain fell in torrents — except at occasional intervals, when it was checked by a violent gust of wind which swept up the streets (for it is in London that our scene lies), rattling along the housetops, and fiercely agitating the scanty flame of the lamps that struggled against the darkness.\n" +
    "\n" +
    "She walked quickly down the street, her heels clicking loudly on the pavement. The sun beat down on her face, causing her to squint and pull her hat lower over her eyes. As she turned the corner, she saw him standing there, leaning against the wall with a sly grin on his face. She sighed and walked over to him, trying to ignore the butterflies in her stomach.\n" +
    "\n" +
    "The old man sat by the fireplace, staring into the flames. His hands trembled slightly as he lifted the teacup to his lips, and he could feel the warmth spreading through his body. He closed his eyes and listened to the crackling of the logs and the ticking of the clock on the mantelpiece. It was a peaceful moment, and he savored it, knowing that it would not last forever.\n" +
    "\n" +
    "There once was a boy who lived in a small village at the foot of a mountain. He dreamed of exploring the world beyond his village, but he knew that it was forbidden. One day, he decided to climb the mountain, despite the warnings of his elders. As he climbed higher and higher, he felt his heart pounding in his chest, and his legs grew tired. But he refused to give up. Finally, he reached the summit and looked out at the world below. And he knew that he had made the right choice.\n" +
    "\n",

    //2
    "The sun shone brightly in the clear blue sky as the gentle breeze blew through the trees. Birds sang sweetly as they flitted from branch to branch, and the sound of a distant river could be heard in the distance. It was a beautiful day, and the world seemed alive with energy and possibility.\n" +
    "\n" +
    "As I walked through the woods, I marveled at the beauty of nature around me. The trees towered overhead, their branches reaching towards the sky like outstretched fingers. Leaves rustled underfoot as I made my way along the winding path, and I breathed in the fresh, clean scent of the forest.\n" +
    "\n" +
    "As I rounded a bend in the path, I came across a small clearing. In the center of the clearing stood a single tree, its trunk thick and gnarled, its branches spreading outwards in all directions. I approached the tree and ran my hand over its rough bark, marveling at its age and strength.\n" +
    "\n" +
    "For a long time, I stood there in the clearing, lost in thought. I felt a deep connection to the natural world around me, and I knew that I would always carry a piece of it with me, wherever I went. And as the sun began to dip below the horizon, I turned and made my way back down the path, filled with a sense of peace and contentment." +
    "\n",

    //3
    "The city streets were crowded with people hurrying to and fro, their footsteps echoing off the tall buildings that loomed above them. Cars honked their horns as they jostled for position in the traffic, and the sounds of sirens and construction filled the air.\n" +
    "\n" +
    "I walked through the throngs of people, my eyes scanning the faces around me. There were so many different types of people, each with their own story to tell. Some were dressed in suits and carrying briefcases, others were in jeans and t-shirts, and still others were wrapped in blankets and huddled on the street corners.\n" +
    "\n" +
    "As I walked, I became aware of a man walking just a few steps behind me. I could feel his presence, and it made me uneasy. I quickened my pace, but he matched my stride, never falling behind. I turned a corner, hoping to lose him in the crowd, but he followed me still.\n" +
    "\n" +
    "Finally, I stopped and turned to face him. He was tall and thin, with deep-set eyes and a thin-lipped mouth. His gaze was intense, and I felt a shiver run down my spine.\n" +
    "\n" +
    "\"Can I help you?\" I asked, my voice trembling slightly.\n" +
    "\n" +
    "The man smiled, and my unease only grew. \"I think you have something that belongs to me,\" he said, his voice low and menacing.\n" +
    "\n" +
    "I shook my head, trying to back away, but he stepped forward, his hand outstretched. I turned and ran, my heart pounding in my chest as I heard his footsteps behind me. I ran until I was out of breath, and then I collapsed on a nearby bench, gasping for air.\n" +
    "\n" +
    "As I sat there, trying to regain my composure, I realized that the man was nowhere to be seen. I had escaped, but the memory of his chilling smile lingered in my mind." +
    "\n",

    //4
    "The greatest glory in living lies not in never falling, but in rising every time we fall. Nelson Mandela said this, and he knew a thing or two about rising above adversity. Mandela was a South African anti-apartheid revolutionary who spent 27 years in prison before becoming the country's first black president. Despite the enormous challenges he faced, Mandela remained committed to his vision of a free and equal South Africa. He dedicated his life to the cause of justice and inspired millions of people around the world to do the same.\n" +
    "\n" +
    "Today, Mandela is remembered as one of the greatest leaders of the 20th century. His legacy continues to inspire people to fight for freedom, justice, and equality. As he once said, \"It always seems impossible until it's done.\" We can all learn something from Mandela's example, and strive to rise above our own challenges with courage and determination." +
    "\n",

    //5
    "The quick brown fox jumps over the lazy dog. This sentence is a classic example of a pangram, which is a sentence that uses every letter of the alphabet at least once. Pangrams are often used to test typing speed and accuracy, as they require the typist to type a variety of letters in quick succession.\n" +
    "\n" +
    "Typing quickly and accurately is an important skill in today's fast-paced world. Whether you're typing emails, reports, or social media posts, being able to type quickly and accurately can save you time and improve your productivity.\n" +
    "\n" +
    "To improve your typing skills, try practicing with a variety of texts, like this one. Focus on typing with proper finger placement and use all ten fingers to type. Remember to keep your eyes on the screen and avoid looking down at your keyboard.\n" +
    "\n" +
    "With practice and dedication, anyone can improve their typing speed and accuracy. So, start typing now and see how much you can improve!" +
    "\n",

    //6
    "Daenerys Targaryen wed Khal Drogo with fear and barbaric splendor in a field beyond the walls of\n" +
    "Pentos, for the Dothraki believed that all things of importance in a man's life must be done beneath the\n" +
    "open sky.\n" +
    "Drogo had called his khalasar to attend him and they had come, forty thousand Dothraki warriors and\n" +
    "uncounted numbers of women, children, and slaves. Outside the city walls they camped with their vast\n" +
    "herds, raising palaces of woven grass, eating everything in sight, and making the good folk of Pentos\n" +
    "more anxious with every passing day.\n" +
    "\"My fellow magisters; have doubled the size of the city guard,\" Illyrio told them over platters of honey\n" +
    "duck and orange snap peppers one night at the manse that had been Drogo's. The khal had joined his\n" +
    "khalasar, his estate given over to Daenerys and her brother until the wedding.",

    //7
    "The visitors poured through the castle gates in a river of gold and silver and polished steel, three hundred\n" +
    "strong, a pride of bannermen and knights, of sworn swords and freeriders. Over their heads a dozen\n" +
    "golden banners whipped back and forth in the northern wind, emblazoned with the crowned stag of\n" +
    "Baratheon.\n" +
    "Ned knew many of the riders. There came Ser Jaime Lannister with hair as bright as beaten gold, and\n" +
    "there Sandor Clegane with his terrible burned face. The tall boy beside him could only be the crown\n" +
    "prince, and that stunted little man behind them was surely the Imp, Tyrion Lannister.\n" +
    "Yet the huge man at the head of the column, flanked by two knights in the snow-white cloaks of the\n" +
    "Kingsguard, seemed almost a stranger to Ned . . . until he vaulted off the back of his warhorse with a\n" +
    "familiar roar, and crushed him in a bone-crunching hug. \"Ned! Ah, but it is good to see that frozen face of\n" +
    "yours.\" The king looked him over top to bottom, and laughed. \"You have not changed at all.",

    //8
    "Somewhere in the great stone maze of Winterfell, a wolf howled. The sound hung over the castle like a\n" +
    "flag of mourning.\n" +
    "Tyrion Lannister looked up from his books and shivered, though the library was snug and warm.\n" +
    "Something about the howling of a wolf took a man right out of his here and now and left him in a dark\n" +
    "forest of the mind, running naked before the pack.\n" +
    "When the direwolf howled again, Tyrion shut the heavy leatherbound cover on the book he was reading,\n" +
    "a hundredyear-old discourse on the changing of the seasons by a long-dead maester. He covered a yawn\n" +
    "with the back of his hand. His reading lamp was flickering, its oil all but gone, as dawn light leaked\n" +
    "through the high windows. He had been at it all night, but that was nothing new. Tyrion Lannister was not\n" +
    "much a one for sleeping",

    //9
    "on climbed the steps slowly, trying not to think that this might be the last time ever. Ghost padded silently\n" +
    "beside him. Outside, snow swirled through the castle gates, and the yard was all noise and chaos, but\n" +
    "inside the thick stone walls it was still warm and quiet. Too quiet for Jon's liking.\n" +
    "He reached the landing and stood for a long moment, afraid. Ghost nuzzled at his hand. He took courage\n" +
    "from that. He straightened, and entered the room.\n" +
    "Lady Stark was there beside his bed. She had been there, day and night, for close on a fortnight. Not\n" +
    "for a moment had she left Bran's side. She had her meals brought to her there, and chamber pots as well,\n" +
    "and a small hard bed to sleep on, though it was said she had scarcely slept at all. She fed him herself, the\n" +
    "honey and water and herb mixture that sustained life. Not once did she leave the room. So Jon had\n" +
    "stayed away.",

    //10
    "She could hear the dead man coming up the steps. The\n" +
    "slow, measured sound of footsteps went before him,\n" +
    "echoing amongst the purple pillars of her hall. Daenerys\n" +
    "Targaryen awaited him upon the ebon bench that she had\n" +
    "made her throne. Her eyes were soft with sleep, her silvergold hair all tousled.\n" +
    "“Your Grace,” said Ser Barristan Selmy, the lord\n" +
    "commander of her Queensguard, “there is no need for you\n" +
    "to see this.”\n" +
    "“He died for me.” Dany clutched her lion pelt to her chest.\n" +
    "Underneath, a sheer white linen tunic covered her to\n" +
    "midthigh. She had been dreaming of a house with a red\n" +
    "door when Missandei woke her. There had been no time to\n" +
    "dress.\n" +
    "“Khaleesi,” whispered Irri, “you must not touch the dead\n" +
    "man. It is bad luck to touch the dead.”\n" +
    "“Unless you killed them yourself.” Jhiqui was biggerboned than Irri, with wide hips and heavy breasts. “That is\n" +
    "known.”",

    //11
    "For a long while he did not stir, but lay unmoving upon the\n" +
    "heap of old sacks that served him for a bed, listening to the\n" +
    "wind in the lines, to the lapping of the river at the hull.\n" +
    "A full moon floated above the mast. It is following me\n" +
    "downriver, watching me like some great eye. Despite the\n" +
    "warmth of the musty skins that covered him, a shiver went\n" +
    "through the little man. I need a cup of wine. A dozen cups\n" +
    "of wine. But the moon would blink before that whoreson\n" +
    "Griff let him quench his thirst. Instead he drank water, and\n" +
    "was condemned to sleepless nights and days of sweats\n" +
    "and shakes.",

    //12
    "The Shy Maid moved through the fog like a blind man\n" +
    "groping his way down an unfamiliar hall.\n" +
    "Septa Lemore was praying. The mists muffled the sound\n" +
    "of her voice, making it seem small and hushed. Griff paced\n" +
    "the deck, mail clinking softly beneath his wolfskin cloak.\n" +
    "From time to time he touched his sword, as if to make\n" +
    "certain that it still hung at his side. Rolly Duckfield was\n" +
    "pushing at the starboard pole, Yandry at the larboard. Ysilla\n" +
    "had the tiller.\n" +
    "“I do not like this place,” Haldon Halfmaester muttered.\n" +
    "“Frightened of a little fog?” mocked Tyrion, though in truth\n" +
    "there was quite a lot of fog. At the prow of the Shy Maid,\n" +
    "Young Griff stood with the third pole, to push them away\n" +
    "from hazards as they loomed up through the mists."
]
//choose a random text
let text = text_repo[Math.floor(Math.random() * text_repo.length)];
let text_container = document.querySelector(".inner-container");
//time container to show time
let time_container = document.querySelector(".time");
//a modal for when time finished and for show the result of the test
let modal = document.querySelector(".modal");
//all the text page
let container = document.querySelector(".text-container");
//first page that show the button of time
let btn_container = document.querySelector(".container");
//choose time button
let time_button = document.querySelectorAll(".type-in-x-minute");
//show history buttons
let one_min_button = document.querySelector(".button1_container")
let three_min_button = document.querySelector(".button2_container")
let five_min_button = document.querySelector(".button3_container")
//history container
let history_container = document.querySelector(".history");


//time variable is our current time, and it is changed every second
//all_time is the total time for calculate the speed at the end
let time, all_time;
let text_set = false;
let first_test_started = false, second_test_started = false, third_test_started = false
let history_array = [], history_index = 0;

//these buttons are for show history
one_min_button.addEventListener("click", function (ev) {
    //set style for the buttons
    one_min_button.classList.add("btn_con_selected")
    three_min_button.classList.remove("btn_con_selected")
    five_min_button.classList.remove("btn_con_selected")
    //read from localStorage
    let all_history_array = JSON.parse(localStorage.getItem("history"))
    //show histories that are related to one min test
    let array = [], index = 0;
    for(let i = 0; all_history_array !== null && i < all_history_array.length; i++) {
        if(all_history_array[i].split(" ")[4] === "first") {
            array[index] = all_history_array[i];
            index++;
        }
    }
    setHistory(array)

})
three_min_button.addEventListener("click", function (ev) {
    one_min_button.classList.remove("btn_con_selected")
    three_min_button.classList.add("btn_con_selected")
    five_min_button.classList.remove("btn_con_selected")
    let all_history_array = JSON.parse(localStorage.getItem("history"))
    let array = [], index = 0;
    for(let i = 0; all_history_array !== null && i < all_history_array.length; i++) {
        if(all_history_array[i].split(" ")[4] === "second") {
            array[index] = all_history_array[i];
            index++;
        }
    }
    setHistory(array)
})
five_min_button.addEventListener("click", function (ev) {
    one_min_button.classList.remove("btn_con_selected")
    three_min_button.classList.remove("btn_con_selected")
    five_min_button.classList.add("btn_con_selected")
    let all_history_array = JSON.parse(localStorage.getItem("history"))
    let array = [], index = 0;
    for(let i = 0; all_history_array !== null && i < all_history_array.length; i++) {
        if(all_history_array[i].split(" ")[4] === "third") {
            array[index] = all_history_array[i];
            index++;
        }
    }
    setHistory(array)
})
function setHistory(array) {

    //clear the history container
    let H_child = history_container.lastChild;
    while (H_child !== null) {
        history_container.removeChild(H_child);
        H_child = history_container.lastChild;
    }

    //set history container elements
    for(let i = 0; array !== null && i < array.length; i++) {
        let objs = array[i].split(" ");
        let month = objs[0];
        let day = objs[1];
        let speed = objs[2];
        let accuracy = objs[3];

        let new_rec = document.createElement("div");
        new_rec.classList.add("record");


        let date = document.createElement("div");
        date.classList.add("record_child");
        date.classList.add("date")

        let main = document.createElement("div");
        main.classList.add("main");

        let month_div = document.createElement("div");
        month_div.classList.add("month");
        month_div.innerHTML = month;

        let day_div = document.createElement("div");
        day_div.classList.add("day")
        day_div.innerHTML = day;

        main.append(month_div, day_div);
        date.append(main);

        let speed_div = document.createElement("div");
        speed_div.classList.add("record_child");
        speed_div.innerHTML = "Speed: " + speed + " WPM"

        let accuracy_div = document.createElement("div");
        accuracy_div.classList.add("record_child");
        accuracy_div.innerHTML = "Accuracy: " + accuracy + "%"

        new_rec.append(date, speed_div, accuracy_div)

        history_container.append(new_rec)
    }

    let title = document.createElement("h1");
    title.innerHTML = "History";
    title.classList.add("history_title")
    history_container.append(title);
}

//this loop is iterate the time selection button to handle the mouse click
for (let i = 0; i < time_button.length; i++)
    time_button[i].addEventListener("click", function (ev) {
        //set the time to test and the all_time that is equals to the time before it start
        if(i === 0) {
            first_test_started = true;
            time = 60
        }
        if(i === 1) {
            second_test_started = true;
            time = 180
        }
        if(i === 2) {
            third_test_started = true;
            time = 300
        }

        all_time = time
        //switch to another page by click on a button
        btn_container.style.display = "none";
        time_container.style.display = "flex"
        container.style.display = "flex"
        document.body.style.justifyContent = "flex-start"
        text_set = true;
        //set the time container
        setTime();
    })


//all the letter on the text is a pre tag that these tags is saved in an array
let children = [];
for (let i = 0; i < text.length; i++) {
    let elem = document.createElement("pre");
    elem.innerHTML = text.charAt(i);
    elem.classList.add("letter");
    children[i] = elem;
    //after create a pre tage by a letter of the text, append it to the text container
    text_container.appendChild(elem);
}

//index is the number of current letter that must be typed, tues is the letters that correct typed and the falses is for incorrect letters
let index = 0, trues = 0, falses = 0, started = false;
//index is on first letter and assigned the proper class
children[index].classList.add("selected-letter");

//for when a key is presses, except backspace
document.addEventListener("keypress", function (ev) {
    ev.preventDefault()
    if(text_set) {
        //if the time is not started, by press a key time will be start
        if(!started) {
            startInterval();
            started = true;
        }
        //check to if the key that press is the correct key
        if(ev.key === children[index].innerHTML) {
            children[index].classList.remove("selected-letter");
            children[index].classList.add("true-letter");
            index++;
            trues++;
        }else {
            children[index].classList.remove("selected-letter");
            children[index].classList.add("false-letter");
            index++;
            falses++;
        }
        children[index].classList.add("selected-letter")
    }
})
//if the backspace pressed
document.addEventListener("keydown", function (ev) {
    if (text_set) {
        if(!started){
            startInterval();
            started = true
        }
        if(ev.key === "Backspace") {
            children[index].classList.remove("selected-letter")
            if(index > 0)
                index--;
            if(getComputedStyle(children[index]).backgroundColor === "rgba(91, 197, 56, 0.2)") {
                if(trues > 0)
                    trues--
                children[index].classList.remove("true-letter")
            }else {
                if(falses > 0)
                    falses--;
                children[index].classList.remove("false-letter")
            }
            children[index].classList.add("selected-letter")
        }
    }
})

//this interval every second set the time container and check if the time is finished
function startInterval() {
    let interval = setInterval(function () {
        if(time >= 0) {
            setTime();
        }else {
            //time is finished
            let speed = Math.floor((trues / 5) / (all_time / 60))
            let accuracy = Math.floor(100 * (1 - (falses / (falses + trues))));
            document.querySelector(".modal p").innerHTML = "Your speed was " + speed + " WPM with " + accuracy + " accuracy!"
            clearInterval(interval);
            time_container.style.display = "none";
            setTimeout(function () {
                container.style.display = "none";
                modal.style.display = "flex"
            }, 1000)
            container.className += " hidden"

            let month = new Date().toString().split(" ")[1]
            let day = new Date().toString().split(" ")[2]

            //check that which test started
            if (first_test_started) {
                first_test_started = false;
                //read from localStorage
                callback_history();
                //set array to set in the localStorage
                history_array[history_index] = month + " " + day + " " + speed + " " + accuracy + " " + "first";
                history_index++;
            }else if(second_test_started) {
                second_test_started = false;
                //read from localStorage
                callback_history();
                //set array to set in the localStorage
                history_array[history_index] = month + " " + day + " " + speed + " " + accuracy + " " + "second";
                history_index++;
            }else {
                third_test_started = false;
                //read from localStorage
                callback_history();
                //set array to set in the localStorage
                history_array[history_index] = month + " " + day + " " + speed + " " + accuracy + " " + "third";
                history_index++;
            }
            //set localStorage
            localStorage.setItem("history", JSON.stringify((history_array)))
        }

    }, 1000)
}

function callback_history() {
    let array = JSON.parse(localStorage.getItem("history"));
    for(let i = 0; array !== null && i < array.length; i++) {
        history_array[i] = array[i];
        history_index = i + 1;
    }
}
//for set the time on the time container
function setTime() {
    let minute = Math.floor(time / 60);
    let second = time % 60;
    let minutestr = minute, secondstr= second;
    if(minute < 10)
        minutestr = "0" + minute;
    if(second < 10)
        secondstr = "0" + second;
    time_container.innerHTML = minutestr + ":" + secondstr;
    time--;
}